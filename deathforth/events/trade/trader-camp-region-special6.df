uses paul/region-layout.df
// "../deathforth/rooms/TEMPROOM.txt" $load-rooms
	
" 
:map 2 
:tags prepperstairs
:scriptA prepperturret 
:size 7 10 
:off 10 3 
:tiles 
2222222
2333332
21A1A12
2111112
2112112
2112662
2112662
2112112
2222222
3333333

:map 2
:tags prepperend  
:scriptA preppertrader
:scriptB still-npc .redturretify
:scriptC bed 
:scriptD nkitchenset 
:scriptE diningset 
:scriptF nbathsetsmall 2 movex 
:scriptG prepper-magchance 
:scriptH livingset
:size 27 23 
:off 1 1 
:tiles 
000000000002222200000000000
000000000002333200000000000
000000000002111200000000000
000000000002666200000000000
000000000002666200000000000
222222000002666200000002222
233222222222666200000002332
2C12223333326662000222221C2
21133211F113111200023333112
2A111211G111111222221111112
211212222222212222221222112
211213333333313333331232112
2C12111111111111111112021C2
222222221222222222122222222
333233331333333333133332333
0002111111111D111111A112000
00021A111111111111111112000
000211111122222221111A12000
000211111122222221111112000
00021111E123333321H11112000
00021B111120000021111B12000
000222222220000022222222000
000333333330000033333333000
"
value PREPPERCAMP
PREPPERCAMP $parse-rooms

cyoa{

: prepperturret-grab clear-cyoa deleteme goodfx turretgreen drop southofcyoa ;

cyoa-choice: prepperturret-hack
	cmechanic+ if
		($ pname .. "  usa le sue abilita per capire come ripristinare la torretta nel suo stato di spiegamento!		" .. "TORRETTA GRATUITA!" rainbold $) cyoa-text! mechanicREV prepperturret-grab
	else
		($ pname .. "  cerca di usare la forza bruta per schiacciare la torretta nel suo stato di trasporto!		" .. "GRAAAAAAAAAAAAAH!" rbold $) cyoa-text!
		cstrength+ if
			"Incredibilmente, funziona davvero!" +crtext prepperturret-grab
		else
			($ "Is not a valid operator in C " .. pname .. " si prende una bella scossa." $) +crtext bitefx sting-- morale--
		then strengthREV 
	then
;

cyoa: prepperturret
	"Ladro di Torrette" cyoa-title!
	picon!
	($ "Questa torretta fa cose da torretta. Ronza, cerca nemici e via dicendo. Wow, guardala andare! Un piccolo problema " .. "Non e il TUO torretta!" rbold $) cyoa-text!
		choice( "Lascia stare" )choice
		pchar charchoice( " prova a rubare la torretta" )choice: prepperturret-hack
;

0 value pt1-1
0 value pt1-2
0 value pt1-3

cyoa-choice: trade-p1-3
	($ Thegroup .. " 	Comprato un lanciafiamme Napalm modificato per il doppio della capacita!" .. "Parla del fuoco amico! Davvero, fai attenzione ai compagni di squadra." pbold $) cyoa-text! goodfx
	100 WEAPON_NAPALM trunk.weapon+ -16 trunk-food+ someicon ' pt1-3 ++
;

cyoa-choice: trade-p1-2
	($ Thegroup .. "  acquista un bazooka modificato con otto razzi!	" .. "Carnage TOTALE! Lo adoro!" pbold $) cyoa-text! goodfx
	8 WEAPON_BAZOOKA trunk.weapon+ -12 trunk-food+ someicon ' pt1-2 ++
;

cyoa-choice: trade-p1-1
	($ Thegroup .. "  acquista un lanciagranate modificato con 15 granate!	" .. "Vedi quanti zombi riesci a splattare in una volta!" pbold $) cyoa-text! goodfx
	15 WEAPON_GLAUNCH trunk.weapon+ -12 trunk-food+ someicon ' pt1-1 ++
;

cyoa: preptrader1
	"Carnage Weapons XL" cyoa-title!
	($ "Ho gia modificato tutte queste armi DEVASTANTI per avere il doppio della capacita o piu! Non puoi trovarle da nessun'altra parte!" pbold $) cyoa-text!
	trunk-food 11 > if "Ora si che siamo a cavallo." +crtext then
	basic-tone foodamt
	trunk-food 12 < if
		($ Thegroup .. " e DEVASTATO nel sapere che non possono permettersi nulla." $) +crtext
	else
		choice( "Lascia per ora" )choice back-esc
		trunk-food 15 > pt1-3 1 < and if
			choice( "'palm" )choice: trade-p1-3
		then
		trunk-food 11 > pt1-2 1 < and if
			choice( "1 shots per food" )choice: trade-p1-2
		then
		trunk-food 11 > pt1-1 1 < and if
			choice( "Food per shot" )choice: trade-p1-1
		then
	then
;

0 value pt2-1
0 value pt2-2
0 value pt2-3

cyoa-choice: trade-p2-3
	($ Thegroup .. "  acquista il " .. "Minigun!" fbold .. "  E lapice della fornitura di munizioni per fucili!	" .. "Ho venduto questo con uno sconto enorme perche ci ho messo accidentalmente sopra delle macchie di burro di arachidi." pbold $) cyoa-text! goodfx
	1 WEAPON_MINIGUN trunk.weapon+ -35 trunk-food+ someicon ' pt2-3 ++
;
	
cyoa-choice: trade-p2-2
	($ Thegroup .. "  acquista il " .. "BIG DAWG" rbold .. "'. E un fucile a pompa personalizzato unico nel suo genere! Ogni colpo e una massiccia esplosione di schizzi di zombi." $) cyoa-text! goodfx ' pt2-2 ++
	1 WEAPON_DAWG trunk.weapon+ -20 trunk-food+ picon
;

cyoa-choice: trade-p2-1
	($ Thegroup .. "  acquista il " .. "PISTOLA DORATA" rbold .. ". Ha una quantita insolita di potenza e penetrazione del colpo per una pistola, inoltre e bella e lucida." $) cyoa-text! goodfx ' pt2-1 ++
	1 WEAPON_GOLDPISTOL trunk.weapon+ -15 trunk-food+ picon
;

cyoa: preptrader2
	"Armi di punta" cyoa-title!
	($ "Benvenuti a " pbold .. "PARADISO DEI PREPPER!" rainbold .. " 'Vendo solo le MIGLIORI armi! Il fucile piu grande, il fucile automatico piu veloce e la pistola piu lucida!" pbold $) cyoa-text!
	basic-tone foodamt
	trunk-food 15 < if
		($ Thegroup .. "  non ha abbastanza cibo per comprare qualcosa!" $) +crtext
		($ "'Non preoccuparti, ci penso io." pbold .. "  Il commerciante strizza locchio e poi da " .. thegroup .. "  il " .. "'PICCOLO CANE!" rbold $) +crtext goodfx 1 WEAPON_LILDAWG trunk.weapon+ clear-cyoa
	else
		choice( "Lascia per ora" )choice back-esc
		trunk-food 34 > pt2-3 1 < and if
			choice( "Minigun   35 cibo" )choice: trade-p2-3
		then
		trunk-food 19 > pt2-2 1 < and if
			choice( "Fucile a pompa BIG DAWG   20 cibo" )choice: trade-p2-2
		then
		trunk-food 14 > pt2-1 1 < and if
			choice( "Pistola doro   15 cibo" )choice: trade-p2-1
		then
	then
;

0 value pt3-1
0 value pt3-2
0 value pt3-3

cyoa-choice: trade-p3-3
	($ Thegroup .. "  acquista il " .. "Spray curativo XL!" rbold .. "  Usalo per curarti o per danneggiare un gruppo di zombi.	" .. "A volte lo spruzzo anche sul mio cibo." pbold $) cyoa-text! goodfx
	10 WEAPON_HEALSPRAY trunk.weapon+ -10 trunk-food+ someicon ' pt3-3 ++
;
	
cyoa-choice: trade-p3-2
	($ Thegroup .. "  acquista un " .. "COLTELLO DA SOPRAVVIVENZA" rbold .. "'. E leggero, facile da maneggiare anche se esausti e puo colpire costantemente due zombi in un colpo solo." $) cyoa-text! goodfx ' pt3-2 ++
	1 WEAPON_SURVKNIFE trunk.weapon+ -6 trunk-food+ picon
;

cyoa-choice: trade-p3-1
	($ Thegroup .. "  acquista un " .. "ARCO CON 50 FRECCE" rbold .. ". Gli archi traggono vantaggio da ogni statistica: forza, forma fisica e tiro rendono gli archi piu potenti." $) cyoa-text! goodfx ' pt3-1 ++
	50 WEAPON_BOW trunk.weapon+ -5 trunk-food+ picon
;

cyoa: preptrader3
	"Attrezzatura di sopravvivenza" cyoa-title!
	($ "'Sto scambiando alcuni attrezzi di sopravvivenza convenienti ed efficaci! Gli archi sono ottimi per abbattere gli zombi in silenzio, soprattutto se sei abbastanza atletico da usarli bene. Se hai il cibo, ho molte frecce extra in magazzino." pbold $) cyoa-text!
	basic-tone foodamt
	trunk-food 5 < if
		($ Thegroup .. "  non ha abbastanza cibo per comprare un arco!" $) +crtext
		($ "Il commerciante ha un po di pieta di " .. thegroup .. " e distribuisce " .. "un coltello da sopravvivenza gratuito, e un arco con 12 frecce!" rbold $) +crtext goodfx 12 WEAPON_BOW trunk.weapon+ 1 WEAPON_SURVKNIFE trunk.weapon+ clear-cyoa
	else
		choice( "Lascia per ora" )choice back-esc
		trunk-food 9 > pt3-3 1 < and if
			choice( "Spray curativo XL   10 spray   10 cibo" )choice: trade-p3-3
		then
		trunk-food 5 > pt3-2 2 < and if
			choice( "Coltello da sopravvivenza   6 cibo" )choice: trade-p3-2
		then
		trunk-food 4 > pt3-1 8 < and if
			choice( "Arco con 50 frecce   5 cibo" )choice: trade-p3-1
		then
	then
;

: delta-good args( chara )
	"Bene " pchar .name@ $cat
	"Male " pchar .name@ $cat pchar .name!
;

: delta-cool args( chara )
	"Fantastico " <- chara .name@ $cat
;

: deltrarecruit-rename
	ricon recruitee .name! ($ "DELTA" pbold .. "' il nome e ora " .. rname .. "!" $) cyoa-text! goodfx
;

cyoa-choice: deltarecruit-name1
	"Smellberto" deltrarecruit-rename
	"Che nome nuovo orribile! Eppure ha un pizzico di esotico." +crtext
;

cyoa-choice: deltarecruit-name2
	"Harry Hamm" deltrarecruit-rename 
	$( rname .. " 'era uno dei nomi piu popolari per cani, prima dello Zombocalypse. Da non confondere con il potentissimo nome umano, Harry Ham." $) +crtext 
;

cyoa-choice: deltarecruit-name3
	cchar delta-cool deltrarecruit-rename 
	($ "Questo nome e ancora piu bello, in qualche modo." $) +crtext
;

cyoa-choice: deltarecruit-name4
	cchar delta-good deltrarecruit-rename 
	"Che bel nome!" +crtext
	($ pname .. " si sente triste." $) +crtext
	pchar .morale--
;

cyoa-bridge: deltarecruit-name
	ricon "'Quale dovrebbe essere il nuovo nome del cane supersoldato?" text!
	choice( "Smellberto" )choice: deltarecruit-name1
	choice( "Harry Hamm" )choice: deltarecruit-name2
	choice( "Fantastico " .. rname )choice: deltarecruit-name3
	choice( "Bene " .. pchar .name@ )choice: deltarecruit-name4
;

cyoa-bridge: deltarecruit-go
	ricon 4 recruitee .morale! clear-cyoa 0.25 recruitee .ai.wander_chance! 0 nearest .unseen!
	($ "Now without a cause, DELTA decides to follow a new master...... YOU..........." rbold $) cyoa-text!
	-10 trunk-food+ goodfx
	
	team-full? if
		($ "Il gruppo e pieno. Chi vorresti sostituire per fare spazio a " .. rname .. "?" $) +crtext
		recruit-replace?
	else
		recruited
		($ "Vorresti dare a " .. rname .. " un nuovo nome?" $) +crtext
		choice( "NO" )choice
		choice( "SI" )choice: deltarecruit-name
	then
	
	WEAPON_SHOTGUN recruitee .weaponb! 	20 LOOT_SHOTGUN_SHELL recruitee .lootamt!
;

cyoa: deltarecruit
	"PROGETTO: DELTA" cyoa-title!
	nearest .character@ choosechar cchar to recruitee ricon
	($ cname .. " is a supersoldier dog trained by the government.
	Now that the government has fallen, DELTA seeks a new master......... for the right price........" rbold $) cyoa-text!
	" " bbold +text basic-tone
	trunk-food 9 > if
		choice( "Lascia per ora" )choice
		choice( "Recluta DELTA   10 cibo" )choice: deltarecruit-go
	else
		choice( "'Non posso risparmiare il cibo" )choice
	then		
;
	
}

roomgen{


: .pt1 args( ch ) 
	10 <- ch .hattype! // Helmet, modded explosives
;
: .pt2 args( ch ) 
	11 <- ch .hattype! // General's Hat, fancy weapons
;
: .pt3 args( ch ) 
	12 <- ch .hattype! // Camo Hat, cheap survival
;

: preptradercommon
	still-npc regiondef{ ' trader-event lt .events! 1 lt .timer! }
	
;

: preptrader1
	preptradercommon .pt1 cyoa{ ' preptrader1 cyoa! }
;

: preptrader2
	preptradercommon .pt2 cyoa{ ' preptrader2 cyoa! }
;

: preptrader3
	preptradercommon .pt3 cyoa{ ' preptrader3 cyoa! }
;

: preptrader4
	preptradercommon .deltaify cyoa{ ' deltarecruit cyoa! }
;

		0 stack
			' preptrader1 shove
			' preptrader2 shove
			' preptrader3 shove
			' preptrader4 shove
		value preptrader-base
		preptrader-base shuffles var preptrader-picker

: preppertrader
	preptrader-picker depths 0= if preptrader-base shuffles to preptrader-picker then pops nip execute ;

: prepperturret
	still-npc .greenturretify cyoa{ ' prepperturret cyoa! } ;

}

locdef{

location: preppercamp
		max-rooms: 2
		entry-tags: prepperstairs
		script: set-theme-bunker
		pre-script: set-theme-bunker
		post-script: nad 0 %zombs
		
		: prepstart
			s edge-inc s random-edge-door "prepperend" only-with-door
		;
		
		
		room-choice: prepperstairs
			room-weight: 10
			room-count: 1
			room-post-script: prepstart
			filter-only
		
		room-choice: prepperend
			room-weight: 10
			room-count: 1
			filter-only

}
		
root{

: prepper-magchance
	20 %chance if
		magazine 0 4 rnd cyoa{ to bookmagtype ' bookmag-get cyoa! } 50 health! drift
	then
;

}
		
map{ regiondef{

trade-camp-reset

0 value gbx
0 value gby
0 value gbx2
0 value gby2
0 value bfx
0 value bfy

: bldg tanchor!
	"preppercamp" $picklocid addloc

	prefab{ 5 bunker }
	
;

: preplogs-big
	2 for biglog 50 %chance if 40 160 else 270 390 then rnd 30 120 rnd lt .pos! next
	ultimalog 10 420 rnd 10 40 rnd lt .pos!
	// lt-here 60 rdrift
;

: pt
	
	xyp.i char 1 = if xyp.x to bfx then;
	xyp.i char 2 = if bfx xyp.y xyp.x barbfence then;

	xyp.i char t = if pine lt-here drift then;
	// xyp.i char S = if trader-food-for-gas then;
	xyp.i char U = if tnomey-spawn then;
	xyp.i char W = if trader-weapon-buyer then;
	
	xyp.i char L = if 2 for log lt-here 40 rdrift next then;
	xyp.i char B = if preplogs-big then;
	
	xyp.i char @ = if xyp.xy bldg then;

	xyp.i char 5 = if xyp.xy to gby to gbx then;
	xyp.i char 6 = if gbx 1- gby xyp.xy swap 1+ swap 4dup gravelbox grasshole then;
	
	xyp.i char < = if xyp.xy to gby2 to gbx2 then;
	xyp.i char > = if gbx2 1- gby2 xyp.xy map{ 4dup dirtbox grasshole } then;
;

"
...........................
..t.t.t.t.t.t.t.t.t.t.t.t..
.......................B...
..t.t.....5...........t.t..
...........................
..t.t.................t.t..
...........................
..t.t..L...........L..t.t..
...........@...............
..t.t.................t.t..
................6..........
..t.t.................t.t..
...........................
..t.t.................t.t..
...........................
.<.........................
1..........2....1.........2
......W.............U......
...........................
...........>...............
...........................
...........................
...........................
...........................
...........................
...........................
..........................."
constant maplayout

: specialcamp-6
	0 -1 maplayout xyplot: pt
;


: site-setup

	// Clear the map with grass
	-1 -1 w h grassbox

	// Plot trader stuff
	specialcamp-6

	// Add dirt road at bottom
	-1 h 5 - w h 4dup map{ dirtbox grasshole }

	1 no_time!
	7 14 rnd o'clock
	50 %chance if 1 2 frnd weather! -1 -2 frnd wind_force! else 1 2 frnd wind_force! then
	
	mission{ no-edge-spawns }
	
	18 %mv-up
	30 %chars-up
;

	 region: specialcamp-6
		w: maplayout layoutw
		h: maplayout layouth

		trade-mode

		post-script: site-setup
} }
