uses paul/region-layout.df
// "../deathforth/rooms/TEMPROOM.txt" $load-rooms
	
" 
:map 2 
:tags prepperstairs
:scriptA prepperturret 
:size 7 10 
:off 10 3 
:tiles 
2222222
2333332
21A1A12
2111112
2112112
2112662
2112662
2112112
2222222
3333333

:map 2
:tags prepperend  
:scriptA preppertrader
:scriptB still-npc .redturretify
:scriptC bed 
:scriptD nkitchenset 
:scriptE diningset 
:scriptF nbathsetsmall 2 movex 
:scriptG prepper-magchance 
:scriptH livingset
:size 27 23 
:off 1 1 
:tiles 
000000000002222200000000000
000000000002333200000000000
000000000002111200000000000
000000000002666200000000000
000000000002666200000000000
222222000002666200000002222
233222222222666200000002332
2C12223333326662000222221C2
21133211F113111200023333112
2A111211G111111222221111112
211212222222212222221222112
211213333333313333331232112
2C12111111111111111112021C2
222222221222222222122222222
333233331333333333133332333
0002111111111D111111A112000
00021A111111111111111112000
000211111122222221111A12000
000211111122222221111112000
00021111E123333321H11112000
00021B111120000021111B12000
000222222220000022222222000
000333333330000033333333000
"
value PREPPERCAMP
PREPPERCAMP $parse-rooms

cyoa{

: prepperturret-grab clear-cyoa deleteme goodfx turretgreen drop southofcyoa ;

cyoa-choice: prepperturret-hack
	cmechanic+ if
		($ pname .. " nutzt ihre Fahigkeiten um herauszufinden wie das Turret in seinen Bereitstellzustand zuruckgesetzt werden kann!		" .. "GRATIS TURRET!" rainbold $) cyoa-text! mechanicREV prepperturret-grab
	else
		($ pname .. " versucht mit Kraft zu versuchen das Turret in sein Tragzustand zuruckzudrucken!		" .. "GRAAAAAAAAAAAAAH!" rbold $) cyoa-text!
		cstrength+ if
			"Aber wundersam genug funktioniert das!" +crtext prepperturret-grab
		else
			($ "'Das funktioniert so gut wie erwartet. Zusatzlich " .. pname .. "  wird ziemlich geschockt." $) +crtext bitefx sting-- morale--
		then strengthREV 
	then
;

cyoa: prepperturret
	"Geschutzturm Dieb" cyoa-title!
	picon!
	($ "Dieser Geschutzturm macht Geschutzturmsachen. Surren, nach Gegnern suchen, so weiter. Wow, sieh nur, wie er lauft! Ein kleines Problem " .. "'Es ist nicht DEIN Geschutzturm!" rbold $) cyoa-text!
		choice( "Lass es in Ruhe" )choice
		pchar charchoice( "  versucht den Geschutzturm zu stehlen" )choice: prepperturret-hack
;

0 value pt1-1
0 value pt1-2
0 value pt1-3

cyoa-choice: trade-p1-3
	($ Thegroup .. "  kauft einen Napalmwerfer mit doppelter Kapazitat!	" .. "Sprechen Sie uber freundliches FEUER! Im Ernst, achten Sie auf Teamkollegen." pbold $) cyoa-text! goodfx
	100 WEAPON_NAPALM trunk.weapon+ -16 trunk-food+ someicon ' pt1-3 ++
;

cyoa-choice: trade-p1-2
	($ Thegroup .. "  kauft eine Panzerfaust mit acht Raketen!	" .. "TOTALE Verwustung! Ich liebe es!" pbold $) cyoa-text! goodfx
	8 WEAPON_BAZOOKA trunk.weapon+ -12 trunk-food+ someicon ' pt1-2 ++
;

cyoa-choice: trade-p1-1
	($ Thegroup .. "  kauft einen Granatwerfer mit 15 Granaten!	" .. "Sehen Sie wie viele Zombies Sie auf einmal zerplatzen lassen konnen!" pbold $) cyoa-text! goodfx
	15 WEAPON_GLAUNCH trunk.weapon+ -12 trunk-food+ someicon ' pt1-1 ++
;

cyoa: preptrader1
	"Verwustungswaffen XL" cyoa-title!
	($ "'Ich habe all diese bereits VERHEERENDEN Waffen so modifiziert dass sie die doppelte Kapazitat oder mehr haben! Sie konnen diese nirgendwo anders bekommen!" pbold $) cyoa-text!
	trunk-food 11 > if "'JETZT reden wir." +crtext then
	basic-tone foodamt
	trunk-food 12 < if
		($ Thegroup .. " ' ist am Boden zerstort als sie erfahren dass sie sich nichts leisten konnen." $) +crtext
	else
		choice( "Gehen Sie vorerst" )choice back-esc
		trunk-food 15 > pt1-3 1 < and if
			choice( "'Napalm Launcher XL   100 'Palme   16 Essen" )choice: trade-p1-3
		then
		trunk-food 11 > pt1-2 1 < and if
			choice( "Bazooka XL   8 Schusse   12 Essen" )choice: trade-p1-2
		then
		trunk-food 11 > pt1-1 1 < and if
			choice( "Granatwerfer XL   15 Schusse   12 Essen" )choice: trade-p1-1
		then
	then
;

0 value pt2-1
0 value pt2-2
0 value pt2-3

cyoa-choice: trade-p2-3
	($ Thegroup .. "  kauft die " .. "Minigun!" fbold .. "  Es ist der Hohepunkt der Gewehrmunitionslieferung!	" .. "Ich habe das mit einem massiven Rabatt verkauft weil ich versehentlich Erdnussbutterflecken darauf bekommen habe." pbold $) cyoa-text! goodfx
	1 WEAPON_MINIGUN trunk.weapon+ -35 trunk-food+ someicon ' pt2-3 ++
;
	
cyoa-choice: trade-p2-2
	($ Thegroup .. "  kauft die " .. "GROER HUND" rbold .. "'. Es ist eine einzigartige magefertigte Schrotflinte! Jeder Schuss ist eine gewaltige Explosion aus Zombie Spritzen." $) cyoa-text! goodfx ' pt2-2 ++
	1 WEAPON_DAWG trunk.weapon+ -20 trunk-food+ picon
;

cyoa-choice: trade-p2-1
	($ Thegroup .. "  kauft die " .. "GOLDENE PISTOLE" rbold .. ". Es hat eine ungewohnlich hohe Leistung und Durchschlagskraft fur eine Pistole und ist auerdem schon und glanzend." $) cyoa-text! goodfx ' pt2-1 ++
	1 WEAPON_GOLDPISTOL trunk.weapon+ -15 trunk-food+ picon
;

cyoa: preptrader2
	"Spitzenwaffen" cyoa-title!
	($ "Willkommen bei " pbold .. "PREPPER PARADIES!" rainbold .. " ' Ich verkaufe nur die BESTEN Waffen! Die grote Schrotflinte, das schnellste Sturmgewehr und die glanzendste Pistole!" pbold $) cyoa-text!
	basic-tone foodamt
	trunk-food 15 < if
		($ Thegroup .. " hat nicht genugend Nahrung um etwas zu kaufen!" $) +crtext
		($ "'Keine Sorge, ich ubernehme das." pbold .. "  Der Handler zwinkert und gibt dann " .. thegroup .. "  das " .. "'LIL' DAWG!" rbold $) +crtext goodfx 1 WEAPON_LILDAWG trunk.weapon+ clear-cyoa
	else
		choice( "Gehen Sie vorerst" )choice back-esc
		trunk-food 34 > pt2-3 1 < and if
			choice( "Minigun   35 Nahrung" )choice: trade-p2-3
		then
		trunk-food 19 > pt2-2 1 < and if
			choice( "BIG DAWG Shotgun   20 Nahrung" )choice: trade-p2-2
		then
		trunk-food 14 > pt2-1 1 < and if
			choice( "Golden Pistol   15 Nahrung" )choice: trade-p2-1
		then
	then
;

0 value pt3-1
0 value pt3-2
0 value pt3-3

cyoa-choice: trade-p3-3
	($ Thegroup .. "  kauft die " .. "Heilspray XL!" rbold .. "  Benutze es, um dich selbst zu heilen oder um eine Gruppe von Zombies zu beschadigen.	" .. "Manchmal spruhe ich es sogar auf mein Essen." pbold $) cyoa-text! goodfx
	10 WEAPON_HEALSPRAY trunk.weapon+ -10 trunk-food+ someicon ' pt3-3 ++
;
	
cyoa-choice: trade-p3-2
	($ Thegroup .. "  kauft einen " .. "UBERLEBENS MESSER" rbold .. "'. Es ist leicht, auch bei Erschopfung leicht zu schwingen und kann zwei Zombies auf einmal konstant treffen." $) cyoa-text! goodfx ' pt3-2 ++
	1 WEAPON_SURVKNIFE trunk.weapon+ -6 trunk-food+ picon
;

cyoa-choice: trade-p3-1
	($ Thegroup .. "  kauft einen " .. "BOGEN MIT 50 PFEILEN" rbold .. ". Bogen profitieren von jedem Wert: Starke, Fitness und Schieen machen Bogen starker." $) cyoa-text! goodfx ' pt3-1 ++
	50 WEAPON_BOW trunk.weapon+ -5 trunk-food+ picon
;

cyoa: preptrader3
	"Uberlebensausrustung" cyoa-title!
	($ "'Ich tausche erschwingliche und effektive Uberlebensausrustung! Bogen eignen sich hervorragend, um Zombies lautlos zu erledigen, besonders wenn man athletisch genug ist, um sie gut zu benutzen. Wenn du das Essen hast, habe ich viele zusatzliche Pfeile auf Lager." pbold $) cyoa-text!
	basic-tone foodamt
	trunk-food 5 < if
		($ Thegroup .. "  hat nicht genug Essen um uberhaupt einen Bogen zu kaufen!" $) +crtext
		($ "Der Handler hat etwas Mitleid mit " .. thegroup .. "  und verteilt " .. "ein kostenloses Uberlebensmesser und einen Bogen mit 12 Pfeilen!" rbold $) +crtext goodfx 12 WEAPON_BOW trunk.weapon+ 1 WEAPON_SURVKNIFE trunk.weapon+ clear-cyoa
	else
		choice( "Gehen Sie vorerst" )choice back-esc
		trunk-food 9 > pt3-3 1 < and if
			choice( "Heilungsspray XL   10 Sprays   10 Essen" )choice: trade-p3-3
		then
		trunk-food 5 > pt3-2 2 < and if
			choice( "Uberlebensmesser   6 Essen" )choice: trade-p3-2
		then
		trunk-food 4 > pt3-1 8 < and if
			choice( "Bogen mit 50 Pfeilen   5 Essen" )choice: trade-p3-1
		then
	then
;

: delta-good args( chara )
	"Gut " pchar .name@ $cat
	"Schlecht " pchar .name@ $cat pchar .name!
;

: delta-cool args( chara )
	"Cool " <- chara .name@ $cat
;

: deltrarecruit-rename
	ricon recruitee .name! ($ "DELTA" pbold .. "''s Name ist jetzt " .. rname .. "!" $) cyoa-text! goodfx
;

cyoa-choice: deltarecruit-name1
	"Smellberto" deltrarecruit-rename
	"Was fur ein schrecklich neuer Name! Und doch hat er einen Hauch von Exotik." +crtext
;

cyoa-choice: deltarecruit-name2
	"Harry Hamm" deltrarecruit-rename 
	$( rname .. " 'war einer der beliebtesten Hundenamen, kurz vor der Zombocalypse. Nicht zu verwechseln mit dem sehr machtigen menschlichen Namen 'Harry Ham'." $) +crtext 
;

cyoa-choice: deltarecruit-name3
	cchar delta-cool deltrarecruit-rename 
	($ "Dieser Name ist irgendwie noch cooler." $) +crtext
;

cyoa-choice: deltarecruit-name4
	cchar delta-good deltrarecruit-rename 
	"Was fur ein toller Name!" +crtext
	($ pname .. " fuhlt sich unglucklich." $) +crtext
	pchar .morale--
;

cyoa-bridge: deltarecruit-name
	ricon "'Wie soll der neue Name des Supersoldatenhundes lauten?" text!
	choice( "Smellberto" )choice: deltarecruit-name1
	choice( "Harry Hamm" )choice: deltarecruit-name2
	choice( "Cool " .. rname )choice: deltarecruit-name3
	choice( "Gut " .. pchar .name@ )choice: deltarecruit-name4
;

cyoa-bridge: deltarecruit-go
	ricon 4 recruitee .morale! clear-cyoa 0.25 recruitee .ai.wander_chance! 0 nearest .unseen!
	($ "Now without a cause, DELTA decides to follow a new master...... YOU..........." rbold $) cyoa-text!
	-10 trunk-food+ goodfx
	
	team-full? if
		($ "Die Gruppe ist voll.		Wen wurdest du gerne ersetzen um Platz fur " .. rname .. "?" $) +crtext
		recruit-replace?
	else
		recruited
		($ "Mochtest du " .. rname .. "  einen neuen Namen geben?" $) +crtext
		choice( "NEIN" )choice
		choice( "JA" )choice: deltarecruit-name
	then
	
	WEAPON_SHOTGUN recruitee .weaponb! 	20 LOOT_SHOTGUN_SHELL recruitee .lootamt!
;

cyoa: deltarecruit
	"PROJEKT: DELTA" cyoa-title!
	nearest .character@ choosechar cchar to recruitee ricon
	($ cname .. " is a supersoldier dog trained by the government.
	Now that the government has fallen, DELTA seeks a new master......... for the right price........" rbold $) cyoa-text!
	" " bbold +text basic-tone
	trunk-food 9 > if
		choice( "Gehen Sie vorerst" )choice
		choice( "Rekrut DELTA   10 Nahrung" )choice: deltarecruit-go
	else
		choice( "'Kann das Essen nicht entbehren" )choice
	then		
;
	
}

roomgen{


: .pt1 args( ch ) 
	10 <- ch .hattype! // Helmet, modded explosives
;
: .pt2 args( ch ) 
	11 <- ch .hattype! // General's Hat, fancy weapons
;
: .pt3 args( ch ) 
	12 <- ch .hattype! // Camo Hat, cheap survival
;

: preptradercommon
	still-npc regiondef{ ' trader-event lt .events! 1 lt .timer! }
	
;

: preptrader1
	preptradercommon .pt1 cyoa{ ' preptrader1 cyoa! }
;

: preptrader2
	preptradercommon .pt2 cyoa{ ' preptrader2 cyoa! }
;

: preptrader3
	preptradercommon .pt3 cyoa{ ' preptrader3 cyoa! }
;

: preptrader4
	preptradercommon .deltaify cyoa{ ' deltarecruit cyoa! }
;

		0 stack
			' preptrader1 shove
			' preptrader2 shove
			' preptrader3 shove
			' preptrader4 shove
		value preptrader-base
		preptrader-base shuffles var preptrader-picker

: preppertrader
	preptrader-picker depths 0= if preptrader-base shuffles to preptrader-picker then pops nip execute ;

: prepperturret
	still-npc .greenturretify cyoa{ ' prepperturret cyoa! } ;

}

locdef{

location: preppercamp
		max-rooms: 2
		entry-tags: prepperstairs
		script: set-theme-bunker
		pre-script: set-theme-bunker
		post-script: nad 0 %zombs
		
		: prepstart
			s edge-inc s random-edge-door "prepperend" only-with-door
		;
		
		
		room-choice: prepperstairs
			room-weight: 10
			room-count: 1
			room-post-script: prepstart
			filter-only
		
		room-choice: prepperend
			room-weight: 10
			room-count: 1
			filter-only

}
		
root{

: prepper-magchance
	20 %chance if
		magazine 0 4 rnd cyoa{ to bookmagtype ' bookmag-get cyoa! } 50 health! drift
	then
;

}
		
map{ regiondef{

trade-camp-reset

0 value gbx
0 value gby
0 value gbx2
0 value gby2
0 value bfx
0 value bfy

: bldg tanchor!
	"preppercamp" $picklocid addloc

	prefab{ 5 bunker }
	
;

: preplogs-big
	2 for biglog 50 %chance if 40 160 else 270 390 then rnd 30 120 rnd lt .pos! next
	ultimalog 10 420 rnd 10 40 rnd lt .pos!
	// lt-here 60 rdrift
;

: pt
	
	xyp.i char 1 = if xyp.x to bfx then;
	xyp.i char 2 = if bfx xyp.y xyp.x barbfence then;

	xyp.i char t = if pine lt-here drift then;
	// xyp.i char S = if trader-food-for-gas then;
	xyp.i char U = if tnomey-spawn then;
	xyp.i char W = if trader-weapon-buyer then;
	
	xyp.i char L = if 2 for log lt-here 40 rdrift next then;
	xyp.i char B = if preplogs-big then;
	
	xyp.i char @ = if xyp.xy bldg then;

	xyp.i char 5 = if xyp.xy to gby to gbx then;
	xyp.i char 6 = if gbx 1- gby xyp.xy swap 1+ swap 4dup gravelbox grasshole then;
	
	xyp.i char < = if xyp.xy to gby2 to gbx2 then;
	xyp.i char > = if gbx2 1- gby2 xyp.xy map{ 4dup dirtbox grasshole } then;
;

"
...........................
..t.t.t.t.t.t.t.t.t.t.t.t..
.......................B...
..t.t.....5...........t.t..
...........................
..t.t.................t.t..
...........................
..t.t..L...........L..t.t..
...........@...............
..t.t.................t.t..
................6..........
..t.t.................t.t..
...........................
..t.t.................t.t..
...........................
.<.........................
1..........2....1.........2
......W.............U......
...........................
...........>...............
...........................
...........................
...........................
...........................
...........................
...........................
..........................."
constant maplayout

: specialcamp-6
	0 -1 maplayout xyplot: pt
;


: site-setup

	// Clear the map with grass
	-1 -1 w h grassbox

	// Plot trader stuff
	specialcamp-6

	// Add dirt road at bottom
	-1 h 5 - w h 4dup map{ dirtbox grasshole }

	1 no_time!
	7 14 rnd o'clock
	50 %chance if 1 2 frnd weather! -1 -2 frnd wind_force! else 1 2 frnd wind_force! then
	
	mission{ no-edge-spawns }
	
	18 %mv-up
	30 %chars-up
;

	 region: specialcamp-6
		w: maplayout layoutw
		h: maplayout layouth

		trade-mode

		post-script: site-setup
} }
