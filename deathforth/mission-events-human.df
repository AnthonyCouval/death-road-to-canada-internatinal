
mission{

// : random-death-phrase

// pick from list
0 stack
	"EPUISER LES PAR" shove
	"OH DANG !" shove
	"MERDE, JE M'EN FOUS" shove
	"C... CANADA" shove
	"noooooo" shove
	"desole, je n'" shove
	"uh wait... aaaaa" shove
	"darn it." shove
	"aboye" shove
	"desole," shove
	"Je n'ai rien a regretter !" shove
	"Je regrette tout !" shove
	"Tell Tim Horton I..." shove
	"aaaaaaaaa!" shove
	"C'est la faute de tous, sauf de moi !" shove
	"Reellement murs, zombis ! reellement murs !" shove
	"aaaaa!" shove
	"heeeelp!" shove
	"A la prochaine sur le cote oppose" shove
	"Cet homme m'en mord !" shove
	"Arrr !" shove
	"Well... could be worse" shove
	"Je savais bien cela arriver !" shove
	"Oh uh... woops!" shove
	"Douleur, douleur !" shove
	"Hey... cut it out" shove
	"Esperez que je ne me transforme pas en un squelette." shove
	"Ne jetez pas mon squelette autour" shove
	"If only I threw more chairs..." shove
	"defoncez-moi, detest" shove
	"malheureusement, je ne peux pas vous" shove
	"C'est bien, c'est bon !" shove
	"Aaaaargh!" shove
	"Bah, c'est pas important !" shove
	"Quelqu'un a besoin du canada, en realite ?" shove
	"Pas de" shove
	"Caaaaaaaaaaaaaaaaarl!" shove
	"Oh desole" shove
	"Attendez, je pense avoir jet mon bout de gum !" shove
	"Arret, arret !" shove
	"Attendez, cela ne comptait pas !" shove
	"Attendez ! je peux recommencer !" shove
	"C'est tout a fault de toi !" shove
	"Uh... I meant to do that!" shove
	"This is aaaaall part of the plan, heh" shove
	"Dis : tous que mes derniers mots etaient cool !" shove
	"Vous etes des tricheurs ! vous etes des zombies tricheurs !" shove
	"Aidez-moi, rosdower !" shove
	"saaave meeeeeee" shove
	"Uhhh... little help?" shove
	"aidez-" shove
	"heeelp meeeee" shove
	"Je n'ai pas a me preoccuper, j'en ai une idee !" shove
	"Oh oui, je me sens mal, j'aurais besoin d'" shove
	"Ne touchez rien de mes affaires !" shove
	"Bury me... with my food cans!" shove
	"Enterre-moi avec mes cles de voiture aimees !" shove
	"Enterre-moi avec une pierre tombale sucree !" shove
	"Malheureusement, plus de chance la prochaine fois." shove
	"C'etait presque ca ! attends, et puis ouch !" shove
	"Je ai un probleme la-bas." shove
	"Cela me fait mal !" shove
	"Ceci est drole !" shove
	"Bring it on!!!" shove
	"WOOOooooooouch!" shove
	"Reponse : pas de probleme ! je l'ai bien." shove
	"Fuitez, s'il vous plait !" shove
	"C'etait une idee maladroite !" shove
	"Attendez ! je sens quelque chose dans l'oeil !" shove
	"Je vais bien. je marcherai dessus !" shove
	"Je me suis eboule, le vent m'a souffle les couilles." shove
	"Rien de special ! je l'ai deja vu pire !" shove
	"Je peux encore faire cela ! attendez un instant !" shove
	"Tout de meme!" shove
	"*regarder les zombies avec degout*" shove
	"Excuse me... stop eating me please" shove
	"C'est un zombie malefique ! mauvais, zombie mauvais !" shove
	"Zombies lents sont pas supposes etre dangereux !" shove
	"eeeeep" shove
	"shrieeeeeeek" shove
	"*g...gulp*" shove
	"Je vais me lancer dans ca maintenant!" shove
	"Je m'en fiche maintenant !" shove
	"C'est ca pour moi !" shove
	"Pas de repit, c'est" shove
	"Pas possible !" shove
	"Either these zombies go... or I do!" shove
	"'gurk" shove
	"hein ? tu repetes 'owowow" shove
	"mouillez" shove
	"OUCH!" shove
	"For cripes sake..." shove
	"Mon eponge est mal" shove
	"Esperons qu'il s'agit que du ketchup" shove
	"Je serais bien sur un oncle de singe si cela etait vrai. je suis mort !" shove
	"KAKAROOOOT!!" shove
	"Le saliva de zombie, degoutant." shove
	"No matter what... you gotta strut" shove
	"I've had worse..." shove
	"EVIDEMMENT, JE NE PE" shove
	"KHAAAAAAAN!!" shove
	"Canada, more like Can'tada" shove
var death-saying-stack

// shuffles pops nip
// ;

0 stack
	"Ces zombies me repondent en return" shove
	"Obtenir des informations un peu personnelles." shove
	"Il n'y a plus d'espoir !" shove
	"*S'ETENDRE LES" shove
	"C'est rien grave, je me suis mordu." shove
	"Coupe ca, gros nerds !" shove
	"Aucune difficulte, je vous don" shove
	"Une petite grosse morsure" shove
	"deux choses legitimes, deux choses pour quitter." shove
	"Je suis trop pompe pour mourir !" shove
	"Arrete de m'agiter !" shove
	"C'est mon sac, je ne le connais pas." shove
	"Ce que vous voulez !" shove
	"SHIELD...OF...HOPE" shove
	"Shield... of.... HOPE" shove
	"Je peux encore le faire ! au canada !" shove
	"I can still run... there's still hope!" shove
	"Encore debout !" shove
	"Oh oh oh oh" shove
	"Pas de probleme, pas de probleme." shove
	"I'm ok... I wasn't bit!" shove
	"Je peux marcher cela hors!" shove
	"Je me sens toujours assez optimiste, je pense !" shove
	"ECU D'ESPOIR !" shove
	"SHIIIIEEEEELLLD OF HOOOOOOOPE!" shove
var shieldofhope-saying-stack

: random-death-phrase death-saying-stack rndpicks nip ;
: shieldofhope-phrase shieldofhope-saying-stack rndpicks nip ;

: .shieldofhope-saying args( thing ) shieldofhope-phrase <- thing statmod{ .yellmsglong } ;
: .death-saying args( thing ) random-death-phrase <- thing statmod{ .yellmsglong } ;
: thingyell .thing@ statmod{ .yellmsglong } ;

: death-handler args( chara )
	<- chara .char-droploot
	deadtally
	
	<- chara dog? if
		70 %chance if
			"whiiiiiiiine" <- chara thingyell
		else
			"ARRROOOOOO!" <- chara thingyell
		then
	then;

	<- chara goat? if
		1 %chance if
			"ceci n'etait pas une reference au goat simulator." fbold <- chara thingyell
		else
			"BAAAAAAAAAAA!" fbold <- chara thingyell
		then
	then;
	
	<- chara pig? if
		1 %chance if
			"UN COCHON PARTICULIER" fbold <- chara thingyell
		else
			"SQUEEEEEL!" rbold <- chara thingyell
		then
	then;	
	
	<- chara cat? if
		1 %chance if
			"j'ode le lundi." fbold <- chara thingyell
		else
			"HISSSSSSSSSSSSS!" fbold <- chara thingyell
		then
	then;
	
	<- chara ispet? if
		"BLORFFF!" <- chara thingyell
	then;

	// TODO: Enumerate special characters instead of using magic numbers

	<- chara .specialtype@ 76 = if RED "*GNOOOOORT*" .. <- chara thingyell then;
	<- chara .specialtype@ 77 = if RED "nuuuuuuurp!" .. <- chara thingyell then;
	
	<- chara .perk@ "BART EST UN" $= if RED "DON'T HAVE.... COW" .. <- chara thingyell then;
	
	<- chara .specialtype@ 79 = if RED "COLD.... STEEEEEEEL" .. <- chara thingyell then;
	<- chara .specialtype@ 93 = if RED "............." .. <- chara thingyell then;
	<- chara .specialtype@ 95 = if RED "YOU ARE DEAD... no wait I am dead" .. <- chara thingyell then;
	<- chara .specialtype@ 97 = if RED "A PLUS TARD, BOUBA." .. <- chara thingyell then;
	<- chara .perk@ "Reine squelette" $= if "Dans le dernier temps, je suis devenu entierement squelette !" <- chara thingyell then;
	<- chara .specialtype@ 104 = if RED "THANKS A LOT... OBAMA... CAAAAAAAAAW" .. <- chara thingyell then;

	<- chara .specialtype@ 106 = if RED "BURY ME... WITH MY LOG" .. <- chara thingyell then;
	<- chara .specialtype@ 108 = if RED "YAAAAARRRRRggghhhhh!" .. <- chara thingyell then;
	<- chara .specialtype@ 109 = <- chara .specialtype@ 110 = or if FLASHY "ZZZZZZZZZT!" .. <- chara thingyell then;
	<- chara .specialtype@ 39 = if RED "ROBOTEUR CHOC !" .. <- chara thingyell then;
	<- chara .specialtype@ 40 = if BLUE "KLAXONNER" .. <- chara thingyell then;
	<- chara .specialtype@ 88 = if FLASHY "CRATOUILLETTE : *UN" .. <- chara thingyell then;
	<- chara .specialtype@ 96 = if RED "JE ME CASSE !" .. <- chara thingyell then;
	<- chara .specialtype@ 98 = if BLUE "UNE AUTRE CATASTROPHE CAUSEE PAR LE COSPLAY !" .. <- chara thingyell then;
	<- chara .specialtype@ 102 = if RED "L'avenir est la boue !" .. <- chara thingyell then;
	<- chara .specialtype@ 10 = if RED "I made a little miscalculation..." .. <- chara thingyell then;
	<- chara .specialtype@ 20 = if RED "Pour les abeilles !" .. <- chara thingyell then;
	<- chara .specialtype@ 90 = if RED "Esperons-le, tous brulons !" .. <- chara thingyell then;
	
	// Default sayings, if none of above apply
	70 %chance if
		<- chara .thing@ .death-saying
	else
		"EPUISER LES PAR" <- chara thingyell
	then
;

statmod{
: human-thing-events (* "EVENEMENT IMPLIQUANT UNE CHOSE HUMAINE. " type PRINTSTACK *) 0 args( thing eventid chara )
	<- thing .character@ -> chara

//	beep
//	"1072: LA CONNEXION DE L' " type <- eventid .s cr

		 <- eventid THING_EVENT_WAS_HIT
		?(
	
		// <- chara .dead? if then; - Doesn't work with a dead cancel
		<- chara .health@ 1 < if
			<- chara isbort? if 
				<- thing .pos 12 xypowboom -1 lt .hitcheck.blast! 
				RED "AY CRUMBO!!!" .. <- chara thingyell
				<- chara .fullheal <- chara .superbortify 
			then;
			<- chara .trait@ "AMERIQUE" $= if 
				<- thing .pos 12 xypowboom -1 lt .hitcheck.blast! 
				RED "CAAAAAAAAAAAAAAW!" .. <- chara thingyell
				<- chara .july4ify 
			then;
			<- chara .trait@ "Un pied dans la fosse" $= if 
				<- thing .pos 12 xypowboom -1 lt .hitcheck.blast! 
				RED "La crane etait en moi tout le temps !" .. <- chara thingyell
				<- chara .deadsamedify
			then;
			<- chara .perk@ "Bouclier de l'espoir" $= <- chara .morale SHIELDOFHOPE_MIN > and if
				<- chara morale--hopeshield
				<- chara .thing@ .shieldofhope-saying
				1 <- chara .health!
				1 <- thing .hitpoints!
			else
				<- chara .trait@ "Phenix" $= if
					<- thing .pos 12 xypowboom -1 lt .hitcheck.blast!
					<- chara .phoenixify
					<- chara .perk@ "Pyromane" $= if then;
					25 <- chara .thing@ .flammability!
				then
			then
		then
			
		);
	
		THING_EVENT_DIED
		?(

			<- chara .name@ type " DIED!!!!" print
			<- chara death-handler

		);

		// Here you can set up anything on the human THING when it's created in a mission
		THING_EVENT_NEW
		?(
			// Change radius to smaller value here if you want

			5 <- thing .rad.x!

		);

		THING_EVENT_GOT_FATIGUED
		?(
			<- chara .tired? if <- chara MOD_TIRED #mod-icon$ <- thing .report then;
		);
;
}

last human-default-events!


// /////////////// //
// HUMAN AI ORDERS //
// /////////////// //

-1 value last-combat-order
-1 value last-tactic-order

: check-new-combat
	last-combat-order orders_combat@ dup ( last order order ) to last-combat-order ( last order ) <> ( true/false )
;

: check-new-tactic
	last-tactic-order orders_tactic@ dup to last-tactic-order <>
;

0 enum COMBAT_AUTO
enum COMBAT_MELEE
enum COMBAT_GUNS
drop

0 enum TACTIC_AUTO
enum TACTIC_FLEE
enum TACTIC_ATTACK
drop

: combat_report
	orders_combat@ case
		COMBAT_MELEE of
			"ECRASONS-LE!"
		endof
		COMBAT_GUNS of 
			"TIREZ!"
		endof
		otherwise
			"IL FAUT EITHER ..."
		( COMBAT_AUTO )
	endcase
;

: tactic_report
	orders_tactic@ case
		TACTIC_FLEE of 
			"COURIR !"
		endof
		TACTIC_ATTACK of
			"LUTTE!"
		endof
		otherwise
			"DEFENDEZ"
		( TACTIC_AUTO )
	endcase
;

: report-orders
	"COMBATS : LES SITUATIONS DANGEREUSES DANS LES " combat_report .. cr$ .. " STRATEGIE : " .. tactic_report ..
	180 view_w 0.5 * 8 msgtickxy2
;

: loyalty-space args( chara )
	<- chara .loyalty 4 > if
		20
	else
		<- chara .loyalty 2 < if
			40
		else
			30
		then
	then
;

: .char-update-tactic-ai args( chara )
	orders_tactic@ case
		TACTIC_FLEE of
			0 <- chara .ai.loot_chance!
			0.01 <- chara .ai.wander_chance! // Don't look around
			0	<- chara .ai.rush_chance!
			4	<- chara .ai.attack_level!
			<- chara loyalty-space 2 /  dup <- chara .ai.follow_leash! 8 + <- chara .ai.safety_leash!
			-1   <- chara .ai.pickup_gun_max!
			-1  <- chara .ai.pickup_melee_max!
		endof
		TACTIC_ATTACK of
			<- chara .composure 4 > if 0.5 else 1 then <- chara .ai.rush_chance!
			0	<- chara .ai.attack_level! 
			<- chara loyalty-space  <- chara .ai.follow_leash!
			1   <- chara .ai.pickup_gun_max!
			3   <- chara .ai.pickup_melee_max!
		endof
		otherwise
			<- chara .composure 2 < if 0.5 else 0 then	<- chara .ai.rush_chance!
			2	<- chara .ai.attack_level! 		
			<- chara loyalty-space	<- chara .ai.follow_leash!
			1   <- chara .ai.pickup_gun_max!
			3   <- chara .ai.pickup_melee_max!
		( TACTIC_AUTO )
	endcase
;

: .char-update-combat-ai args( chara )

	orders_combat@ case
		COMBAT_MELEE of
			0	<- chara .ai.threat_respond_chance!
			1	<- chara .ai.threat_threshold!
			1	<- chara .ai.threat_relax_chance!
		endof
		COMBAT_GUNS of 
			1	<- chara .ai.threat_respond_chance!
			0	<- chara .ai.threat_threshold!
			0	<- chara .ai.threat_relax_chance!
		endof
		otherwise
			1	<- chara .ai.threat_respond_chance!
			0.9	<- chara .ai.threat_threshold!
			0.8	<- chara .ai.threat_relax_chance!
		( COMBAT_AUTO )
	endcase
;

: update-team-combat-ai
	mission-team-stack depths for pops .char-update-combat-ai next drop
;

: update-team-tactic-ai
	mission-team-stack depths for pops .char-update-tactic-ai next drop
;

: .reset-ai
	dup .default-ai-setup 
	.thing@
		0 over .ai.threat_mode!
		0 over .ai.threat_time!
		0 over .ai.safety_time!
	drop
;

: refresh-team-ai

	mission-team-stack depths for pops .reset-ai next drop

	update-team-tactic-ai
	update-team-combat-ai
;

: change-team-orders
	sfx{ fm 1 fx .j! 0.5 fx .duty! 0.5 fx .scale! } // BLURBLURBLE
	refresh-team-ai report-orders
;

last to main-event-mission-orders

: clown-end-day
	road{ nearcanada-day 1 + road-trip-days - } 1 < if
		cheevo: clown-swarm
		zombieclowns
	then
;


: time-music-reset
	' noop to main-event-mission-sunrise
	' noop to main-event-mission-noon
	' noop to main-event-mission-sunset
	' noop to main-event-mission-dusk
	' noop to main-event-mission-nightfall
;


: zombies-setup
	zombiedefaults
	29 stpick if clown-end-day then
;

last to main-event-mission-setup

: .char-special-condition args( char )
	// "Aidez-" <- char .name!
	// <- char .trait@ "Materiel inflammable resistant" $= if - OLD FIREPROOF METHOD
	<- char statmod{ .fireproof? } if
		0 <- char .thing@ .flammability!
	then
;

: mission-ai-config
	mission-team-stack depths for pops .char-special-condition next drop
	refresh-team-ai
; 

last to main-event-mission-start

}
